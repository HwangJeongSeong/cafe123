<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<th:block layout:fragment="headExtra">
  <meta charset="UTF-8"/>
  <title th:text="|리뷰 수정 - ${review.cafe.name}|">리뷰 수정</title>
  <link rel="stylesheet" th:href="@{/css/review-list.css}"/>
  <link rel="stylesheet" th:href="@{/css/review-edit.css}"/>
</th:block>

<div layout:fragment="content" class="container mt-4 review-page">

  <section class="card shadow-sm review-section review-edit">
    <div class="card-body">
      <div class="review-edit__hero">
        <div class="review-edit__hero-pattern" aria-hidden="true"></div>
        <div class="review-edit__hero-content">
          <div class="review-edit__hero-text">
            <h1 class="hero-title" th:text="|${review.cafe.name} 방문 후기를 수정 해보세요|">리뷰 수정</h1>
            <p class="hero-caption">이미 작성한 리뷰를 더 세련되고 생동감 있게 연출해보세요.</p>
          </div>
          <div class="review-edit__hero-meta">
            <div class="review-edit__intro-status">
              <div class="review-edit__current-rating">
                <div class="rating-stars rating-stars--md"
                     th:style="|--rating:${#numbers.formatDecimal(review.rating, 1, 1)}|"
                     aria-hidden="true"></div>
                <span class="review-edit__current-value"
                      th:text="|${#numbers.formatDecimal(review.rating, 1, 1)}점|">4.0점</span>
              </div>
            </div>
            <a th:href="@{|/reviews/${review.id}|}" class="btn btn-outline-secondary btn-sm review-edit__origin-link">
              원본 리뷰 보기
            </a>
          </div>
        </div>
      </div>

      <form id="reviewEditForm"
            th:action="@{/reviews/{id}(id=${review.id})}"
            method="post"
            enctype="multipart/form-data"
            th:object="${form}"
            class="needs-validation review-edit__form" novalidate>
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <section class="form-section" aria-labelledby="reviewEditRatingLabel">
          <fieldset class="review-edit__rating">
            <legend class="visually-hidden">총 만족도 선택</legend>
            <div class="rating-picker">
              <div class="rating-picker__visual">
                <div class="rating-picker__star-wrapper">
                  <div class="rating-stars rating-stars--interactive"
                       data-rating-display
                       th:style="|--rating:${#numbers.formatDecimal(form.rating != null ? form.rating : 4.0, 1, 1)}|"
                       aria-hidden="true"></div>
                  <div class="rate rating-picker__choices"
                       id="editRatingChoices"
                       role="radiogroup"
                       aria-label="별점 선택">
                    <input type="radio" id="edit-rating10" th:field="*{rating}" value="5.0" title="5점" aria-label="5점" required>
                    <label for="edit-rating10"></label>
                    <input type="radio" id="edit-rating9" th:field="*{rating}" value="4.5" title="4.5점" aria-label="4.5점">
                    <label class="half" for="edit-rating9"></label>
                    <input type="radio" id="edit-rating8" th:field="*{rating}" value="4.0" title="4점" aria-label="4점">
                    <label for="edit-rating8"></label>
                    <input type="radio" id="edit-rating7" th:field="*{rating}" value="3.5" title="3.5점" aria-label="3.5점">
                    <label class="half" for="edit-rating7"></label>
                    <input type="radio" id="edit-rating6" th:field="*{rating}" value="3.0" title="3점" aria-label="3점">
                    <label for="edit-rating6"></label>
                    <input type="radio" id="edit-rating5" th:field="*{rating}" value="2.5" title="2.5점" aria-label="2.5점">
                    <label class="half" for="edit-rating5"></label>
                    <input type="radio" id="edit-rating4" th:field="*{rating}" value="2.0" title="2점" aria-label="2점">
                    <label for="edit-rating4"></label>
                    <input type="radio" id="edit-rating3" th:field="*{rating}" value="1.5" title="1.5점" aria-label="1.5점">
                    <label class="half" for="edit-rating3"></label>
                    <input type="radio" id="edit-rating2" th:field="*{rating}" value="1.0" title="1점" aria-label="1점">
                    <label for="edit-rating2"></label>
                    <input type="radio" id="edit-rating1" th:field="*{rating}" value="0.5" title="0.5점" aria-label="0.5점">
                    <label class="half" for="edit-rating1"></label>
                  </div>
                </div>
                <div class="rating-picker__value-group">
                  <span class="rating-picker__value" id="editRatingValue"
                        th:text="${#numbers.formatDecimal(form.rating != null ? form.rating : 4.0, 1, 1)}">4.0</span>
                  <span class="rating-picker__value-caption">현재 선택한 점수</span>
                </div>
              </div>
            </div>
          </fieldset>
        </section>

        <section class="form-section" aria-labelledby="reviewEditContentLabel">
          <div class="form-section__header">

            <div>
              <h2 id="reviewEditContentLabel" class="form-section__title">후기 내용</h2>
            </div>
          </div>
          <div class="review-edit__field">

            <textarea id="content"
                      th:field="*{content}"
                      class="form-control"
                      minlength="5"
                      maxlength="4000"
                      rows="5"
                      placeholder="이용 팁, 추천 메뉴, 분위기 등을 자유롭게 적어주세요."
                      required></textarea>
            <div id="contentCounter" class="review-edit__counter">0자 / 최소 5자</div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="reviewEditMediaLabel">
          <div class="form-section__header">

            <div>
              <h2 id="reviewEditMediaLabel" class="form-section__title">이미지 구성</h2>
            </div>
          </div>

          <div class="review-edit__media">
            <div class="review-edit__upload">
              <label class="form-label" for="editImages">사진 첨부</label>
              <div class="review-edit__upload-box">
                <svg class="review-edit__upload-icon" width="36" height="36" viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v7h3.5a1 1 0 0 1 .77 1.64l-4.5 5a1 1 0 0 1-1.54 0l-4.5-5A1 1 0 0 1 7.5 11H11V4a1 1 0 0 1 1-1Z"/>
                </svg>
                <div class="review-edit__upload-copy">
                  <strong>이미지 끌어다 놓기</strong>
                  <span>또는 버튼으로 선택하세요</span>
                </div>
                <input id="editImages" type="file" name="images" class="form-control" accept="image/*" multiple data-max-files="10">
              </div>
              <p class="upload-hint">최대 10장, 10MB 이하 이미지를 올릴 수 있습니다.</p>
              <ul id="reviewEditFileList"
                  class="review-edit__file-list"
                  aria-live="polite"
                  aria-label="선택한 새 이미지 목록"></ul>
            </div>

            <div class="review-edit__existing"
                 id="existingImageList"
                 th:if="${form.imageUrl != null && !form.imageUrl.isEmpty()}">
              <div class="review-edit__existing-header">
                <h3 class="review-edit__existing-title">등록된 사진</h3>
                <p class="review-edit__existing-hint">유지하려면 그대로 두고, 제거하려면 삭제 버튼을 눌러주세요.</p>
              </div>
              <div class="review-edit__existing-grid">
                <div class="review-edit__existing-item" th:each="img, iterStat : ${form.imageUrl}">
                  <input type="hidden" name="imageUrl" th:value="${img}"/>
                  <img th:src="${img}" alt="등록된 리뷰 이미지">
                  <button type="button"
                          class="review-edit__existing-remove"
                          th:attr="aria-label=${'이미지 ' + (iterStat.index + 1) + ' 삭제'}">
                    &times;
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="form-section form-section--summary" aria-label="리뷰 수정 요약">
          <div class="review-edit__actions">
            <button class="btn btn-primary" type="submit">수정 완료</button>
            <form th:action="@{|/reviews/${review.id}/delete|}" method="post" class="review-edit__delete-form"
                  onsubmit="return confirm('정말 삭제하시겠습니까?');">
              <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button type="submit" class="btn btn-danger">리뷰 삭제</button>
            </form>
            <a th:href="@{|/reviews/${review.id}|}" class="btn btn-outline-secondary">취소</a>
          </div>
        </section>
      </form>
    </div>
  </section>
</div>

<th:block layout:fragment="bodyEndExtra">
  <script th:src="@{/js/review-edit.js}" defer></script>
</th:block>

</html>
